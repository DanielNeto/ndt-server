<!doctype html>
<html lang='en'>

<head>
  <script type='text/javascript' src='ndt7-core.js'></script>
  <script type='text/javascript' src='jquery-1.12.1.min.js'></script>
  <link rel="stylesheet" type="text/css" href="style.css">
  <meta charset='utf-8'>
  <title>ndt7 Speed Test</title>
</head>

<body>
  <h1>NDT-Server Example</h1>
  <div id="inputs">
    <div id="errorInput" style="color:#FF3030;text-align:center"></div><br>
    <label>UBS ID:  </label><input id="ubsIdText" type="text" style="text-align:right;" size=15/>&nbsp;&nbsp;
    <label>Banda Contratada:  </label><input id="bandaContratadaText" type="text" style="text-align:right;" size=10 /> Mb/s
  </div>
  <div id="testWrapper">
    <button type="button" id="startStopBtn" onclick="start()"></button>
    <div id="test">
      <div class="testGroup">
        <div class="testArea2">
          <div class="testName">RTT</div>
          <div id="pingText" class="meterText" style="color:#AA6060"></div>
          <div class="unit">ms</div>
        </div>
        <div class="testArea2">
          <div class="testName">Jitter</div>
          <div id="jitText" class="meterText" style="color:#AA6060"></div>
          <div class="unit">ms</div>
        </div>
        <div class="testArea2">
          <div class="testName">Perda</div>
          <div id="lossText" class="meterText" style="color:#AA6060"></div>
          <div class="unit">%</div>
        </div>
      </div>
      <div class="testGroup">
        <div class="testArea">
          <div class="testName">Download</div>
          <canvas id="dlMeter" class="meter"></canvas>
          <div id="dlText" class="meterText"></div>
          <div class="unit">Mbps</div>
        </div>
        <div class="testArea">
          <div class="testName">Upload</div>
          <canvas id="ulMeter" class="meter"></canvas>
          <div id="ulText" class="meterText"></div>
          <div class="unit">Mbps</div>
        </div>
      </div>
      <div id="ipArea">
        <span id="ip"></span>
      </div>
    </div>
  </div>
  <script type='text/javascript'>
    /* jshint esversion: 6, asi: true */
    /* globals ndt7core */
    var meterBk = /Trident.*rv:(\d+\.\d+)/i.test(navigator.userAgent) ? "#EAEAEA" : "#80808040";
    var dlColor = "#6060AA",
      ulColor = "#616161";
    var progColor = meterBk;

    var testResults = {
      "download": 0,
      "upload": 0,
      "jitter": 0,
      "latency": 0,
      "loss": 0,
      "clientIp": "",
      "clientPort": "",
      "startTime": "",
      "endTime": "",
      "serverIp": "",
      "timestamp": "",
      "uuidDownload": "",
      "uuidUpload": "",
      "ubsId": "",
      "userBw": 0
    };

    var statsCount = 0;
    var previousRTT = 0;
    var elapsedDownload = 0;
    var elapsedUpload = 0;
    var testInterval;

    function I(i) { return document.getElementById(i); }
    function mbpsToAmount(s) {
      return 1 - (1 / (Math.pow(1.3, Math.sqrt(s))));
    }
    function format(d) {
      d = Number(d);
      if (d < 10) return d.toFixed(2);
      if (d < 100) return d.toFixed(1);
      return d.toFixed(0);
    }
    function oscillate() {
      return 1 + 0.02 * Math.sin(Date.now() / 100);
    }
    function isNumber(n) { return !isNaN(parseFloat(n)) && !isNaN(n - 0) }

    //CODE FOR GAUGES
    function drawMeter(c, amount, bk, fg, progress, prog) {
      var ctx = c.getContext("2d");
      var dp = window.devicePixelRatio || 1;
      var cw = c.clientWidth * dp, ch = c.clientHeight * dp;
      var sizScale = ch * 0.0055;
      if (c.width == cw && c.height == ch) {
        ctx.clearRect(0, 0, cw, ch);
      } else {
        c.width = cw;
        c.height = ch;
      }
      ctx.beginPath();
      ctx.strokeStyle = bk;
      ctx.lineWidth = 12 * sizScale;
      ctx.arc(c.width / 2, c.height - 58 * sizScale, c.height / 1.8 - ctx.lineWidth, -Math.PI * 1.1, Math.PI * 0.1);
      ctx.stroke();
      ctx.beginPath();
      ctx.strokeStyle = fg;
      ctx.lineWidth = 12 * sizScale;
      ctx.arc(c.width / 2, c.height - 58 * sizScale, c.height / 1.8 - ctx.lineWidth, -Math.PI * 1.1, amount * Math.PI * 1.2 - Math.PI * 1.1);
      ctx.stroke();
      if (typeof progress !== "undefined") {
        ctx.fillStyle = prog;
        ctx.fillRect(c.width * 0.3, c.height - 16 * sizScale, c.width * 0.4 * progress, 4 * sizScale);
      }
    }

    function validateInputs() {
      let ubsid = I("ubsIdText").value;
      let bandaContratada = I("bandaContratadaText").value;
      if (!isNumber(ubsid)) {
        I("errorInput").textContent = "UBS ID Invalido!";
        return false;
      }
      if (!isNumber(bandaContratada)) {
        I("errorInput").textContent = "Banda Contratada Invalida!";
        return false;
      }
      I("errorInput").textContent = "";

      testResults.ubsId = ubsid;
      testResults.userBw = bandaContratada;
      return true;
    }

    function clearVariables() {
      testResults = {
        "download": 0,
        "upload": 0,
        "jitter": 0,
        "latency": 0,
        "loss": 0,
        "clientIp": "",
        "clientPort": "",
        "startTime": "",
        "endTime": "",
        "serverIp": "",
        "timestamp": "",
        "uuidDownload": "",
        "uuidUpload": "",
        "ubsId": "",
        "userBw": 0
      };
      statsCount = 0;
      previousRTT = 0;
      elapsedDownload = 0;
      elapsedUpload = 0;
    }

    function initUI() {
      drawMeter(I("dlMeter"), 0, meterBk, dlColor, 0);
      drawMeter(I("ulMeter"), 0, meterBk, ulColor, 0);
      I("dlText").textContent = "";
      I("ulText").textContent = "";
      I("pingText").textContent = "";
      I("jitText").textContent = "";
      I("ip").textContent = "";
    }

    function start() {
      if (I("startStopBtn").className !== "running") {
        clearVariables();
        initUI();
        if (validateInputs()) {
          testResults.startTime = new Date().getTime();
          runDownload(function () { runUpload(); })
          I("startStopBtn").disabled = true;
          I("startStopBtn").className = "running";
          testInterval = setInterval(updateUI, 500);
        }
      }
    }

    function stopped() {
      I("startStopBtn").className = "";
      I("startStopBtn").disabled = false;
      testResults.endTime = new Date().getTime();
      console.log(JSON.stringify(testResults));
      clearInterval(testInterval);
      //saveDataDB();
    }

    //this function reads the data sent back by the test and updates the UI
    function updateUI() {

      I("ip").textContent = testResults.clientIp;

      let progDownload = elapsedDownload / 10e06;

      I("dlText").textContent = format(testResults.download);
      drawMeter(I("dlMeter"), mbpsToAmount(Number(testResults.download)), meterBk, dlColor, Number(progDownload), progColor);

      let progUpload = elapsedUpload / 10e06;

      I("ulText").textContent = format(testResults.upload);
      drawMeter(I("ulMeter"), mbpsToAmount(Number(testResults.upload)), meterBk, ulColor, Number(progUpload), progColor);

      I("pingText").textContent = format(testResults.latency);
      I("jitText").textContent = format(testResults.jitter);
      I("lossText").textContent = format(testResults.loss * 100);
    }

    function saveData(info, type) {

      statsCount += 1;
      var speed = 0;

      //Basic Info
      let clientIpPorta = info.ConnectionInfo.Client.split(":");
      testResults.clientPort = clientIpPorta.pop();
      testResults.clientIp = clientIpPorta.join(":");

      let serverIpPorta = info.ConnectionInfo.Server.split(":");
      serverIpPorta.pop();
      testResults.serverIp = serverIpPorta.join(":");

      if (type === 'download') {
        elapsedDownload = info.TCPInfo.ElapsedTime;
        speed = info.TCPInfo.BytesAcked * 8;
        speed /= elapsedDownload;

        let sent = info.TCPInfo.BytesSent;
        let retrans = info.TCPInfo.BytesRetrans;

        testResults.download = speed;
        testResults.loss = retrans / sent;  //only on download

        testResults.uuidDownload = info.ConnectionInfo.UUID;
      }

      if (type === 'upload') {
        elapsedUpload = info.TCPInfo.ElapsedTime;
        speed = info.TCPInfo.BytesReceived * 8;
        speed /= elapsedUpload;

        testResults.upload = speed;

        testResults.uuidUpload = info.ConnectionInfo.UUID;
      }

      let oldLatency = testResults.latency;
      let newLatency = info.TCPInfo.RTT / 1e03;
      testResults.latency += (newLatency - oldLatency) / statsCount;

      // jitter requires 2 RTTs to calculate
      if (statsCount > 1) {
        let oldJitter = testResults.jitter;
        let newJitter = Math.abs(newLatency - previousRTT);

        testResults.jitter += (newJitter - oldJitter) / (statsCount - 1);
      }
      previousRTT = newLatency;

      //ref for maths and magics
      //http://datagenetics.com/blog/november22017/index.html
      //http://www.3rdechelon.net/jittercalc.asp
    }

    function saveDataDB() {
      $.ajax("/ubs", {
        data: JSON.stringify(testResults),
        method: "POST",
        contentType: "application/json",
        success: function (data, status, xhr) {// success callback function
          console.log("Data saved!")
        },
        error: function (a, b, c) {
          console.log("Data not saved!")
        }
      });
    }

    function runSomething(testName, callback) {
      ndt7core.run(location.href, testName,
        function (ev, val) {
          console.log(ev, val)
          if (ev === 'complete') {
            if (callback !== undefined) {
              callback()
            }
            if (val.Test === 'upload') {
              stopped()
            }
            return
          }
          if (ev === 'measurement' && val.Origin === 'server') {
            saveData(val, val.Test)
          }
        })
    }

    function runDownload(callback) {
      runSomething('download', callback)
    }

    function runUpload(callback) {
      runSomething('upload', callback)
    }
    initUI();
  </script>
</body>

</html>